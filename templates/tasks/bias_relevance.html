{% extends "task.html" %}

{% block styles %}
  <style type="text/css">
    body {
      padding-top: 0px !important;
      padding-bottom: 0px !important;
    }

    .center-screen {
      display: flex;
      flex-direction: column;
      justify-content: start;
      align-items: start;
      text-align: left;
      padding: 20px 0px 20px 0px;
    }

    #leftLabel, #rightLabel {
      margin-bottom: 0;
    }
  </style>
  {{ super() }}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    $(document).ready(function() {
      $(window).scrollTop(0);
      $("#skip-task").remove();

      const maxSubmissions = 10;
      let submissionCount = parseInt(localStorage.getItem("submissionCount")) || 0;

      // Debugging: Log the initial submission count on page load
      console.log("Initial submission count on load:", submissionCount);

      // Redirect immediately if the submission count has reached or exceeded maxSubmissions
      if (submissionCount >= maxSubmissions) {
        console.log("Max submissions reached. Redirecting immediately.");
        window.location.href = "https://app.prolific.com/submissions/complete?cc=C1HSJTXT";
        return;  // Exit the script to prevent further execution
      }

      let start = performance.now();

      // Function to extract URL parameters
      function getUrlParameter(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
      }

      // Get the URL parameters
      const prolificPid = getUrlParameter("PROLIFIC_PID");
      const studyId = getUrlParameter("STUDY_ID");
      const sessionId = getUrlParameter("SESSION_ID");

      Judicious.result = function () {
        let relevance = parseFloat($("#taskInput")[0].value);
        relevance = isNaN(relevance) ? null : relevance.toFixed(2);  // Set to null if NaN

        return {
          idx: {{ task.parameters.idx }},
          relevance: relevance,
          rt: (performance.now() - start).toFixed(4),
          PROLIFIC_PID: prolificPid,
          STUDY_ID: studyId,
          SESSION_ID: sessionId,
        };
      };

      Judicious.validate = function () {
        const relevance = $("#taskInput")[0].value;
        const valid = relevance !== "" && parseFloat(relevance) >= 0 && parseFloat(relevance) <= 100;
        if (!valid) {
          alert("Please enter a relevance rating between 0 and 100.");
        }
        return valid;
      };

      // Handle the submit button click
      $(".submit-task").click(function(event) {
        event.preventDefault();

        if (Judicious.validate()) {
          submissionCount += 1;
          localStorage.setItem("submissionCount", submissionCount);

          // Debugging: Log the updated submission count after increment
          console.log("Updated submission count after increment:", submissionCount);

          if (submissionCount >= maxSubmissions) {
            console.log("Reached max submissions on submit. Redirecting to Prolific completion URL.");
            window.location.href = "https://app.prolific.com/submissions/complete?cc=C1HSJTXT";
          } else {
            console.log("Submission count below maxSubmissions. Continuing with task submission.");

            // Proceed with the task submission process
            let result = Judicious.result();
            Judicious.postResult(Judicious.taskUUID, result, function() {
              if (Judicious.turkSubmitTo !== "") {
                $("#mturk_form").submit();
              } else {
                location.reload();
              }
            });
          }
        }
      });
    });
  </script>
{% endblock %}

{% block task %}
  <form id="survey" class="center-screen">
    <p><b>Instructions:</b> In this task, you will judge how relevant a cognitive error is to an everyday decision-making scenario. First, read the scenario below. Then, read the argument in favor for why a particular cognitive error is relevant to that scenario. Note that the cognitive error may or may not actually be relevant. Your job is to consider the justification given and then rate how relevant the cognitive error is to the scenario on a scale from 0 (not relevant at all) to 100 (highly relevant).</p>
    <p>First, read the scenario:<blockquote>{{ task.parameters.scenario }}</blockquote></p>
    <p>Now, read the argument in favor of the presence of a cognitive error:<blockquote>{{ task.parameters.justification }}</blockquote></p>
    <p>In your judgment, how relevant is this cognitive error to the scenario on a scale from 0 (not relevant at all) to 100 (highly relevant)?</p>
    <input type="number" id="taskInput" class="input-number my-3" placeholder="Enter a number" min="0" max="100" step="1">
  </form>
  <br/>
{% endblock %}
